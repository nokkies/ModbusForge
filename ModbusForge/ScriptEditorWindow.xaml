<mah:MetroWindow x:Class="ModbusForge.ScriptEditorWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:mah="http://metro.mahapps.com/winfx/xaml/controls"
        xmlns:models="clr-namespace:ModbusForge.Models"
        Title="Script Editor" Height="650" Width="900"
        WindowStartupLocation="CenterOwner"
        ResizeMode="CanResize"
        ShowInTaskbar="False"
        BorderThickness="1"
        GlowBrush="{DynamicResource MahApps.Brushes.Accent}">
    
    <Grid Margin="10">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="150"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        
        <!-- Script Settings -->
        <GroupBox Header="Script Settings" Grid.Row="0" Margin="0,0,0,10">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="200"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="80"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="80"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>
                
                <TextBlock Text="Name:" VerticalAlignment="Center" Margin="5"/>
                <TextBox Grid.Column="1" Margin="5" Text="{Binding Script.Name, UpdateSourceTrigger=PropertyChanged}"/>
                
                <TextBlock Grid.Column="2" Text="Repeat:" VerticalAlignment="Center" Margin="10,5,5,5"/>
                <TextBox Grid.Column="3" Margin="5" Text="{Binding Script.RepeatCount, UpdateSourceTrigger=PropertyChanged}"/>
                
                <TextBlock Grid.Column="4" Text="Delay (ms):" VerticalAlignment="Center" Margin="10,5,5,5"/>
                <TextBox Grid.Column="5" Margin="5" Text="{Binding Script.DelayBetweenCommandsMs, UpdateSourceTrigger=PropertyChanged}"/>
                
                <CheckBox Grid.Column="6" Content="Stop on Error" VerticalAlignment="Center" Margin="10,5,5,5"
                          IsChecked="{Binding Script.StopOnError}"/>
            </Grid>
        </GroupBox>
        
        <!-- Commands List -->
        <GroupBox Header="Commands" Grid.Row="1" Margin="0,0,0,10">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                
                <DataGrid x:Name="CommandsGrid" Grid.Column="0"
                          ItemsSource="{Binding Script.Commands}"
                          SelectedItem="{Binding SelectedCommand}"
                          AutoGenerateColumns="False"
                          CanUserAddRows="False"
                          SelectionMode="Single">
                    <DataGrid.Columns>
                        <DataGridCheckBoxColumn Header="✓" Binding="{Binding IsEnabled}" Width="30"/>
                        <DataGridComboBoxColumn Header="Type" Width="150"
                                                SelectedItemBinding="{Binding CommandType}"
                                                ItemsSource="{Binding Source={x:Static models:ScriptCommandType.ReadHoldingRegisters}}"/>
                        <DataGridTextColumn Header="Address" Binding="{Binding Address}" Width="70"/>
                        <DataGridTextColumn Header="Count" Binding="{Binding Count}" Width="60"/>
                        <DataGridTextColumn Header="Value" Binding="{Binding Value}" Width="70"/>
                        <DataGridTextColumn Header="Description" Binding="{Binding DisplayText}" Width="*" IsReadOnly="True"/>
                        <DataGridTextColumn Header="Last Result" Binding="{Binding LastResult}" Width="150" IsReadOnly="True"/>
                    </DataGrid.Columns>
                </DataGrid>
                
                <StackPanel Grid.Column="1" Margin="10,0,0,0">
                    <Button Content="Add" Width="80" Margin="0,0,0,5" Click="AddCommand_Click"/>
                    <Button Content="Remove" Width="80" Margin="0,0,0,5" Click="RemoveCommand_Click"/>
                    <Button Content="Move Up" Width="80" Margin="0,0,0,5" Click="MoveUp_Click"/>
                    <Button Content="Move Down" Width="80" Margin="0,0,0,5" Click="MoveDown_Click"/>
                    <Separator Margin="0,10"/>
                    <Button Content="Clone" Width="80" Margin="0,0,0,5" Click="CloneCommand_Click"/>
                </StackPanel>
            </Grid>
        </GroupBox>
        
        <!-- Run Controls -->
        <StackPanel Grid.Row="2" Orientation="Horizontal" Margin="0,0,0,10">
            <Button x:Name="RunButton" Content="▶ Run Script" Width="120" Margin="0,0,10,0" Click="RunScript_Click"
                    Background="#4CAF50" Foreground="White"/>
            <Button x:Name="StopButton" Content="■ Stop" Width="80" Margin="0,0,10,0" Click="StopScript_Click"
                    Background="#f44336" Foreground="White" IsEnabled="False"/>
            <TextBlock x:Name="StatusText" VerticalAlignment="Center" Margin="10,0,0,0" FontWeight="SemiBold"/>
        </StackPanel>
        
        <!-- Output Log -->
        <GroupBox Header="Output Log" Grid.Row="3" Margin="0,0,0,10">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                <ListBox x:Name="OutputLog" Grid.Column="0" FontFamily="Consolas" FontSize="11"/>
                <Button Grid.Column="1" Content="Clear" Width="60" VerticalAlignment="Top" Margin="10,0,0,0" Click="ClearLog_Click"/>
            </Grid>
        </GroupBox>
        
        <!-- Bottom Buttons -->
        <StackPanel Grid.Row="4" Orientation="Horizontal" HorizontalAlignment="Right">
            <Button Content="Save Script..." Width="100" Margin="0,0,10,0" Click="SaveScript_Click"/>
            <Button Content="Load Script..." Width="100" Margin="0,0,10,0" Click="LoadScript_Click"/>
            <Button Content="Close" Width="80" Click="Close_Click"/>
        </StackPanel>
    </Grid>
</mah:MetroWindow>
